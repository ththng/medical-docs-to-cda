<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Patient Report</title>
    <link rel="stylesheet" 
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

    <style>
        /* General styles */
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f9f9f9;
            color: #333;
            margin: 0;
            padding: 0;
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin: 20px 0;
            font-size: 28px;
        }

        /* Container */
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Accordion styles */
        .accordion {
            cursor: pointer;
            padding: 16px;
            border: none;
            background-color: #2980b9;
            color: white;
            text-align: left;
            outline: none;
            margin: 10px 0;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        .accordion:hover {
            background-color: #1d4e6c;
            transform: scale(1.03);
        }

        .accordion:after {
            content: '\002B';
            float: right;
            font-size: 18px;
        }

        .accordion.active:after {
            content: '\2212';
        }

        /* Panel styles */
        .panel {
            display: none;
            padding: 20px;
            background-color: #ecf0f1;
            margin-bottom: 10px;
            border-radius: 8px;
            font-size: 15px;
            line-height: 1.6;
            border: 1px solid #bdc3c7;
        }

        /* List styles */
        ul {
            list-style: none;
            padding-left: 0;
        }

        li {
            margin-bottom: 12px;
            padding: 15px;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        li strong {
            color: #a3acb3;
        }

        /* Section titles */
        h2 {
            font-size: 22px;
            color: #2c3e50;
            margin-top: 20px;
        }

        /* Responsive design */
        @media screen and (max-width: 768px) {
            .accordion {
                font-size: 14px;
            }

            .panel {
                font-size: 13px;
            }

            h1 {
                font-size: 24px;
            }

            h2 {
                font-size: 20px;
            }
        }

        /* Submit button */
        .submit-btn {
            display: flex;
            justify-content: right;
            background-color: #27ae60;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 20px;
            transition: background-color 0.3s ease;
        }
        
        .submit-btn:hover {
            background-color: #219150;
        }
    </style>
    <script th:inline="javascript">
        function toggleAccordion(id, level) {
            const panel = document.getElementById(id);
            const isOpen = panel.style.display === "block";

            // Close all panels of the same level
            const panels = document.querySelectorAll(`.panel[data-level="${level}"]`);
            panels.forEach(p => {
                if (p !== panel) p.style.display = "none";
            });

            // Toggle the clicked panel
            panel.style.display = isOpen ? "none" : "block";

            // Update active state for buttons at the same level
            const buttons = document.querySelectorAll(`.accordion[data-level="${level}"]`);
            buttons.forEach(btn => btn.classList.remove("active"));

            if (!isOpen) {
                document.querySelector(`[onclick*='${id}']`).classList.add("active");
            }
        }

        function addObservation(accordionId) {
            let accordion = document.getElementById(accordionId);
            let ul = accordion.querySelector('ul');
            let index = ul.children.length; // Get the current count of observation fields

            let newLi = document.createElement('li');
            newLi.innerHTML = `
                <label for="description-${index}">Description:</label>
                <input type="text" id="description-${index}" name="observations[${index}].description" />

                <label for="code-${index}">Code:</label>
                <input type="text" id="code-${index}" name="observations[${index}].code" />

                <label for="value-${index}">Value:</label>
                <input type="text" id="value-${index}" name="observations[${index}].value" />

                <label for="units-${index}">Units:</label>
                <input type="text" id="units-${index}" name="observations[${index}].units" />

                <button type="button" onclick="removeObservation(this)">Remove</button>
            `;
            ul.appendChild(newLi);
        }

        function addAllergy(accordionId) {
            let accordion = document.getElementById(accordionId);
            let ul = accordion.querySelector('ul');
            let index = ul.children.length; 
    
            let newLi = document.createElement('li');
            newLi.className = "mb-3 p-3 border rounded bg-white shadow-sm";
            newLi.innerHTML = `
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label fw-bold" for="description-${index}">Description:</label>
                        <input type="text" class="form-control" id="description-${index}" name="allergies[${index}].description" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold" for="code-${index}">Code:</label>
                        <input type="text" class="form-control" id="code-${index}" name="allergies[${index}].code" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold" for="start-${index}">Start:</label>
                        <input type="text" class="form-control" id="start-${index}" name="allergies[${index}].start" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold" for="stop-${index}">Stop:</label>
                        <input type="text" class="form-control" id="stop-${index}" name="allergies[${index}].stop" />
                    </div>
                    <div class="col-12 text-end">
                        <button type="button" class="btn btn-danger btn-sm" onclick="remove(this)">Remove</button>
                    </div>
                </div>
            `;
            ul.appendChild(newLi);
        }

        function addCondition(accordionId) {
            let accordion = document.getElementById(accordionId);
            let ul = accordion.querySelector('ul');
            let index = ul.children.length; 
    
            let newLi = document.createElement('li');
            newLi.className = "mb-3 p-3 border rounded bg-white shadow-sm";
            newLi.innerHTML = `
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label fw-bold" for="description-${index}">Description:</label>
                        <input type="text" class="form-control" id="description-${index}" name="conditions[${index}].description" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold" for="code-${index}">Code:</label>
                        <input type="text" class="form-control" id="code-${index}" name="conditions[${index}].code" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold" for="start-${index}">Start:</label>
                        <input type="text" class="form-control" id="start-${index}" name="conditions[${index}].start" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold" for="stop-${index}">Stop:</label>
                        <input type="text" class="form-control" id="stop-${index}" name="conditions[${index}].stop" />
                    </div>
                    <div class="col-12 text-end">
                        <button type="button" class="btn btn-danger btn-sm" onclick="remove(this)">Remove</button>
                    </div>
                </div>
            `;
            ul.appendChild(newLi);
        }

        function addMedication(accordionId) {
            let accordion = document.getElementById(accordionId);
            let ul = accordion.querySelector('ul');
            let index = ul.children.length - 1;
    
            let newLi = document.createElement('li');
            newLi.innerHTML = `
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label fw-bold" for="description-${index}">Description:</label>
                        <input type="text" class="form-control" id="description-${index}" name="medications[${index}].description" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold" for="code-${index}">Code:</label>
                        <input type="text" class="form-control" id="code-${index}" name="medications[${index}].code" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold" for="start-${index}">Start:</label>
                        <input type="text" class="form-control" id="start-${index}" name="medications[${index}].start" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold" for="stop-${index}">Stop:</label>
                        <input type="text" class="form-control" id="stop-${index}" name="medications[${index}].stop" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold" for="reasonCode-${index}">Reason Code:</label>
                        <input type="text" class="form-control" id="reasonCode-${index}" name="medications[${index}].reasonCode" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold" for="reasonDescription-${index}">Reason Description:</label>
                        <input type="text" class="form-control" id="reasonDescription-${index}" name="medications[${index}].reasonDescription" />
                    </div>
                    <div class="col-12 text-end">
                        <button type="button" class="btn btn-danger btn-sm" onclick="remove(this)">Remove</button>
                    </div>
                </div>
            `;
            ul.appendChild(newLi);
        }

        function addProcedure(accordionId) {
            let accordion = document.getElementById(accordionId);
            let ul = accordion.querySelector('ul');
            let index = ul.children.length - 1;
    
            let newLi = document.createElement('li');
            newLi.innerHTML = `
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label fw-bold" for="description-${index}">Description:</label>
                        <input type="text" class="form-control" id="description-${index}" name="procedures[${index}].description" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold" for="code-${index}">Code:</label>
                        <input type="text" class="form-control" id="code-${index}" name="procedures[${index}].code" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold" for="start-${index}">Start:</label>
                        <input type="text" class="form-control" id="start-${index}" name="procedures[${index}].start" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold" for="stop-${index}">Stop:</label>
                        <input type="text" class="form-control" id="stop-${index}" name="procedures[${index}].stop" />
                    </div>
                    <div class="col-12 text-end">
                        <button type="button" class="btn btn-danger btn-sm" onclick="remove(this)">Remove</button>
                    </div>
                </div>
            `;
            ul.appendChild(newLi);
        }

        function addImagingStudy(accordionId) {
            let accordion = document.getElementById(accordionId);
            let ul = accordion.querySelector('ul');
            let index = ul.children.length - 1;
    
            let newLi = document.createElement('li');
            newLi.innerHTML = `
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label fw-bold" for="description-${index}">Description:</label>
                        <input type="text" class="form-control" id="description-${index}" name="imagingStudies[${index}].description" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold" for="code-${index}">Code:</label>
                        <input type="text" class="form-control" id="code-${index}" name="imagingStudies[${index}].code" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold" for="start-${index}">Start:</label>
                        <input type="text" class="form-control" id="start-${index}" name="imagingStudies[${index}].start" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold" for="stop-${index}">Stop:</label>
                        <input type="text" class="form-control" id="stop-${index}" name="imagingStudies[${index}].stop" />
                    </div>
                    <div class="col-12 text-end">
                        <button type="button" class="btn btn-danger btn-sm" onclick="remove(this)">Remove</button>
                    </div>
                </div>
            `;
            ul.appendChild(newLi);
        }

        function addImmunization(accordionId) {
            let accordion = document.getElementById(accordionId);
            let ul = accordion.querySelector('ul');
            let index = ul.children.length - 1;
    
            let newLi = document.createElement('li');
            newLi.innerHTML = `
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label fw-bold" for="description-${index}">Description:</label>
                        <input type="text" class="form-control" id="description-${index}" name="immunizations[${index}].description" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold" for="code-${index}">Code:</label>
                        <input type="text" class="form-control" id="code-${index}" name="immunizations[${index}].code" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold" for="date-${index}">Date:</label>
                        <input type="text" class="form-control" id="date-${index}" name="immunizations[${index}].date" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold" for="status-${index}">Status:</label>
                        <input type="text" class="form-control" id="status-${index}" name="immunizations[${index}].status" />
                    </div>
                    <div class="col-12 text-end">
                        <button type="button" class="btn btn-danger btn-sm" onclick="remove(this)">Remove</button>
                    </div>
                </div>
            `;
            ul.appendChild(newLi);
        }

        // Function to remove a field
        function remove(button) {
            button.parentElement.remove();
        }
        // TODO: adjust to our data model
        function submitForm(event) {
            event.preventDefault();
        
            let formData = {
                name: document.getElementById("name").value,
                email: document.getElementById("email").value
            };
        
            fetch('/data/check', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById("responseMessage").innerHTML = 
                    `<p style="color: green;">${data.message}</p>`;
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById("responseMessage").innerHTML = 
                    `<p style="color: red;">Something went wrong!</p>`;
            });
        }
    </script>


</head>

<body>
    <h1>Report of Patient: <span th:text="${patientId}"></span></h1>
    <ul>
        <h2><strong>List of Encounters</strong></h2>
        <!-- Loop over Encounters -->
        <li th:each="encounter : ${encounters}">
            <!-- Main Encounter Accordion -->
            <div class="accordion" th:attr="onclick='toggleAccordion(\'encounter-' + ${encounter.id} + '\')'">
                <strong>Start:</strong> <span th:text="${encounter.start}"></span>,
                <strong>Stop:</strong> <span th:text="${encounter.stop}"></span>,
                <strong>Description:</strong> <span th:text="${encounter.description}"></span>
            </div>
            <div th:attr="id='encounter-' + ${encounter.id}" class="panel" data-level="1">
                <strong>Organization ID:</strong> <span th:text="${encounter.organizationId}"></span><br>
                <strong>Provider ID:</strong> <span th:text="${encounter.providerId}"></span><br>
                <strong>Encounter Class:</strong> <span th:text="${encounter.encounterClass}"></span><br>
                <strong>Code:</strong> <span th:text="${encounter.code}"></span><br>
                <strong>Reason Code:</strong> <span th:text="${encounter.reasonCode}"></span><br>
                <strong>Reason Description:</strong> <span th:text="${encounter.reasonDescription}"></span><br>

                <!-- Observations Section -->
                <div class="accordion" th:attr="onclick='toggleAccordion(\'observations-' + ${encounter.id} + '\')'">
                    Observations
                </div>

                <div th:attr="id='observations-' + ${encounter.id}" class="panel" data-level="2">
                    <ul class="list-unstyled" th:with="observation=${observations[encounter.id]}">
                        <li th:if="${observation != null && !observation.isEmpty()}" 
                            th:each="observationItem, iterStat : ${observation}"
                            class="mb-3 p-3 border rounded bg-white shadow-sm">

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold" th:for="'description-' + ${iterStat.index}">Description:</label>
                                    <input type="text" 
                                        class="form-control"
                                        th:id="'description-' + ${iterStat.index}"
                                        th:name="'observations[' + ${iterStat.index} + '].description'"
                                        th:value="${observationItem.description}" />
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label fw-bold" th:for="'code-' + ${iterStat.index}">Code:</label>
                                    <input type="text" 
                                        class="form-control"
                                        th:id="'code-' + ${iterStat.index}"
                                        th:name="'observations[' + ${iterStat.index} + '].code'"
                                        th:value="${observationItem.code}" />
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label fw-bold" th:for="'value-' + ${iterStat.index}">Value:</label>
                                    <input type="text" 
                                        class="form-control"
                                        th:id="'value-' + ${iterStat.index}"
                                        th:name="'observations[' + ${iterStat.index} + '].value'"
                                        th:value="${observationItem.value}" />
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label fw-bold" th:for="'units-' + ${iterStat.index}">Units:</label>
                                    <input type="text" 
                                        class="form-control"
                                        th:id="'units-' + ${iterStat.index}"
                                        th:name="'observations[' + ${iterStat.index} + '].units'"
                                        th:value="${observationItem.units}" />
                                </div>

                                <div class="col-12 text-end">
                                    <button type="button" class="btn btn-danger btn-sm" 
                                            th:attr="onclick='remove(this)'">
                                        Remove
                                    </button>
                                </div>
                            </div>
                        </li>

                        <li th:if="${observation == null || observation.isEmpty()}" 
                            class="text-muted text-center p-3">
                            No observations available
                        </li>
                    </ul>

                    <div class="text-center">
                        <button type="button" class="btn btn-primary" 
                                th:attr="onclick='addObservation(\'observations-' + ${encounter.id} + '\')'">
                            Add Observation
                        </button>
                    </div>
                </div>

                <!-- Allergies Section -->
                <div class="accordion" th:attr="onclick='toggleAccordion(\'allergies-' + ${encounter.id} + '\')'">
                    Allergies
                </div>
                <div th:attr="id='allergies-' + ${encounter.id}" class="panel" data-level="2">
                    <ul class="list-unstyled" th:with="allergy=${allergies[encounter.id]}">
                        <li th:if="${allergy != null && !allergy.isEmpty()}" 
                            th:each="allergyItem, iterStat : ${allergy}"
                            class="mb-3 p-3 border rounded bg-white shadow-sm">

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold" th:for="'description-' + ${iterStat.index}">Description:</label>
                                    <input type="text" 
                                        class="form-control"
                                        th:id="'description-' + ${iterStat.index}"
                                        th:name="'allergies[' + ${iterStat.index} + '].description'"
                                        th:value="${allergyItem.description}" />
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label fw-bold" th:for="'code-' + ${iterStat.index}">Code:</label>
                                    <input type="text" 
                                        class="form-control"
                                        th:id="'code-' + ${iterStat.index}"
                                        th:name="'allergies[' + ${iterStat.index} + '].code'"
                                        th:value="${allergyItem.code}" />
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label fw-bold" th:for="'start-' + ${iterStat.index}">Start:</label>
                                    <input type="text" 
                                        class="form-control"
                                        th:id="'start-' + ${iterStat.index}"
                                        th:name="'allergies[' + ${iterStat.index} + '].start'"
                                        th:value="${allergyItem.start}" />
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label fw-bold" th:for="'stop-' + ${iterStat.index}">Stop:</label>
                                    <input type="text" 
                                        class="form-control"
                                        th:id="'stop-' + ${iterStat.index}"
                                        th:name="'allergies[' + ${iterStat.index} + '].stop'"
                                        th:value="${allergyItem.stop}" />
                                </div>

                                <div class="col-12 text-end">
                                    <button type="button" class="btn btn-danger btn-sm" 
                                            th:attr="onclick='remove(this)'">
                                        Remove
                                    </button>
                                </div>
                            </div>
                        </li>

                        <li th:if="${allergy == null || allergy.isEmpty()}" 
                            class="text-muted text-center p-3">
                            No allergies available
                        </li>
                    </ul>

                    <div class="text-center">
                        <button type="button" class="btn btn-primary" 
                                th:attr="onclick='addAllergy(\'allergies-' + ${encounter.id} + '\')'">
                            Add Allergy
                        </button>
                    </div>
                </div>


                <!-- Conditions Section -->
                <div class="accordion" th:attr="onclick='toggleAccordion(\'conditions-' + ${encounter.id} + '\')'">
                    Conditions
                </div>
                <div th:attr="id='conditions-' + ${encounter.id}" class="panel" data-level="2">
                    <ul class="list-unstyled" th:with="condition=${conditions[encounter.id]}">
                        <li th:if="${condition != null && !condition.isEmpty()}" 
                            th:each="conditionItem, iterStat : ${condition}"
                            class="mb-3 p-3 border rounded bg-white shadow-sm">

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold" th:for="'description-' + ${iterStat.index}">Description:</label>
                                    <input type="text" 
                                        class="form-control"
                                        th:id="'description-' + ${iterStat.index}"
                                        th:name="'conditions[' + ${iterStat.index} + '].description'"
                                        th:value="${conditionItem.description}" />
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label fw-bold" th:for="'code-' + ${iterStat.index}">Code:</label>
                                    <input type="text" 
                                        class="form-control"
                                        th:id="'code-' + ${iterStat.index}"
                                        th:name="'conditions[' + ${iterStat.index} + '].code'"
                                        th:value="${conditionItem.code}" />
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label fw-bold" th:for="'start-' + ${iterStat.index}">Start:</label>
                                    <input type="text" 
                                        class="form-control"
                                        th:id="'start-' + ${iterStat.index}"
                                        th:name="'conditions[' + ${iterStat.index} + '].start'"
                                        th:value="${conditionItem.start}" />
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label fw-bold" th:for="'stop-' + ${iterStat.index}">Stop:</label>
                                    <input type="text" 
                                        class="form-control"
                                        th:id="'stop-' + ${iterStat.index}"
                                        th:name="'conditions[' + ${iterStat.index} + '].stop'"
                                        th:value="${conditionItem.stop}" />
                                </div>

                                <div class="col-12 text-end">
                                    <button type="button" class="btn btn-danger btn-sm" 
                                            th:attr="onclick='remove(this)'">
                                        Remove
                                    </button>
                                </div>
                            </div>
                        </li>

                        <li th:if="${condition == null || condition.isEmpty()}" 
                            class="text-muted text-center p-3">
                            No conditions available
                        </li>
                    </ul>

                    <div class="text-center">
                        <button type="button" class="btn btn-primary" 
                                th:attr="onclick='addCondition(\'conditions-' + ${encounter.id} + '\')'">
                            Add Condition
                        </button>
                    </div>
                </div>

                <!-- Medications Section -->
                <div class="accordion" th:attr="onclick='toggleAccordion(\'medications-' + ${encounter.id} + '\')'">
                    Medications
                </div>
                <div th:attr="id='medications-' + ${encounter.id}" class="panel" data-level="2">
                    <ul class="list-unstyled" th:with="medication=${medications[encounter.id]}">
                        <li th:if="${medication != null && !medication.isEmpty()}" 
                            th:each="medicationItem, iterStat : ${medication}"
                            class="mb-3 p-3 border rounded bg-white shadow-sm">

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold" th:for="'description-' + ${iterStat.index}">Description:</label>
                                    <input type="text" 
                                        class="form-control"
                                        th:id="'description-' + ${iterStat.index}"
                                        th:name="'medications[' + ${iterStat.index} + '].description'"
                                        th:value="${medicationItem.description}" />
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label fw-bold" th:for="'code-' + ${iterStat.index}">Code:</label>
                                    <input type="text" 
                                        class="form-control"
                                        th:id="'code-' + ${iterStat.index}"
                                        th:name="'medications[' + ${iterStat.index} + '].code'"
                                        th:value="${medicationItem.code}" />
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label fw-bold" th:for="'start-' + ${iterStat.index}">Start:</label>
                                    <input type="text" 
                                        class="form-control"
                                        th:id="'start-' + ${iterStat.index}"
                                        th:name="'medications[' + ${iterStat.index} + '].start'"
                                        th:value="${medicationItem.start}" />
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label fw-bold" th:for="'stop-' + ${iterStat.index}">Stop:</label>
                                    <input type="text" 
                                        class="form-control"
                                        th:id="'stop-' + ${iterStat.index}"
                                        th:name="'medications[' + ${iterStat.index} + '].stop'"
                                        th:value="${medicationItem.stop}" />
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label fw-bold" th:for="'reasonCode-' + ${iterStat.index}">Reason Code:</label>
                                    <input type="text" 
                                        class="form-control"
                                        th:id="'reasonCode-' + ${iterStat.index}"
                                        th:name="'medications[' + ${iterStat.index} + '].reasonCode'"
                                        th:value="${medicationItem.reasonCode}" />
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label fw-bold" th:for="'reasonDescription-' + ${iterStat.index}">Reason Description:</label>
                                    <input type="text" 
                                        class="form-control"
                                        th:id="'reasonDescription-' + ${iterStat.index}"
                                        th:name="'medications[' + ${iterStat.index} + '].reasonDescription'"
                                        th:value="${medicationItem.reasonDescription}" />
                                </div>

                                <div class="col-12 text-end">
                                    <button type="button" class="btn btn-danger btn-sm" 
                                            th:attr="onclick='removeMedication(this)'">
                                        Remove
                                    </button>
                                </div>
                            </div>
                        </li>

                        <li th:if="${medication == null || medication.isEmpty()}" class="text-muted text-center p-3">
                            No medications available
                        </li>
                    </ul>

                    <div class="text-center">
                        <button type="button" class="btn btn-primary" 
                                th:attr="onclick='addMedication(\'medications-' + ${encounter.id} + '\')'">
                            Add Medication
                        </button>
                    </div>
                </div>

                <!-- Procedures Section -->
                <div class="accordion" th:attr="onclick='toggleAccordion(\'procedures-' + ${encounter.id} + '\')'">
                    Procedures
                </div>
                <div th:attr="id='procedures-' + ${encounter.id}" class="panel" data-level="2">
                    <ul class="list-unstyled" th:with="procedure=${procedures[encounter.id]}">
                        <li th:if="${procedure != null && !procedure.isEmpty()}">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold" th:for="'description-' + ${iterStat.index}">Description:</label>
                                    <input type="text" class="form-control" th:id="'description-' + ${iterStat.index}"
                                        th:name="'procedures[' + ${iterStat.index} + '].description"
                                        th:value="${procedureItem.description}" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold" th:for="'code-' + ${iterStat.index}">Code:</label>
                                    <input type="text" class="form-control" th:id="'code-' + ${iterStat.index}"
                                        th:name="'procedures[' + ${iterStat.index} + '].code"
                                        th:value="${procedureItem.code}" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold" th:for="'start-' + ${iterStat.index}">Start:</label>
                                    <input type="text" class="form-control" th:id="'start-' + ${iterStat.index}"
                                        th:name="'procedures[' + ${iterStat.index} + '].start"
                                        th:value="${procedureItem.start}" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold" th:for="'reasonCode-' + ${iterStat.index}">Reason Code:</label>
                                    <input type="text" class="form-control" th:id="'reasonCode-' + ${iterStat.index}"
                                        th:name="'procedures[' + ${iterStat.index} + '].reasonCode"
                                        th:value="${procedureItem.reasonCode}" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold" th:for="'reasonDescription-' + ${iterStat.index}">Reason Description:</label>
                                    <input type="text" class="form-control" th:id="'reasonDescription-' + ${iterStat.index}"
                                        th:name="'procedures[' + ${iterStat.index} + '].reasonDescription"
                                        th:value="${procedureItem.reasonDescription}" />
                                </div>
                                <div class="col-12 text-end">
                                    <button type="button" class="btn btn-danger btn-sm" th:attr="onclick='remove(this)'">Remove</button>
                                </div>
                            </div>
                        </li>
                        <li th:if="${procedure == null || procedure.isEmpty()}" class="text-muted text-center p-3">
                            No procedures available
                        </li>
                    </ul>
                    <div class="text-center">
                        <button type="button" class="btn btn-primary" 
                                th:attr="onclick='addProcedure(\'procedures-' + ${encounter.id} + '\')'">
                            Add Procedure
                        </button>
                    </div>
                </div>


                <!-- Imaging Studies Section -->
                <div class="accordion" th:attr="onclick='toggleAccordion(\'imagingStudies-' + ${encounter.id} + '\')'">
                    Imaging Studies
                </div>
                <div th:attr="id='imagingStudies-' + ${encounter.id}" class="panel" data-level="2">
                    <ul class="list-unstyled">
                        <li th:if="${imagingStudy != null && !imagingStudy.isEmpty()}" 
                            th:each="imagingStudyItem, iterStat : ${imagingStudy}"
                            class="mb-3 p-3 border rounded bg-white shadow-sm">

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold" th:for="'modalityDescription-' + ${iterStat.index}">Modality Description:</label>
                                    <input type="text" 
                                        class="form-control"
                                        th:id="'modalityDescription-' + ${iterStat.index}"
                                        th:name="'imagingStudies[' + ${iterStat.index} + '].modalityDescription'"
                                        th:value="${imagingStudyItem.modalityDescription}" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold" th:for="'modalityCode-' + ${iterStat.index}">Modality Code:</label>
                                    <input type="text" 
                                        class="form-control"
                                        th:id="'modalityCode-' + ${iterStat.index}"
                                        th:name="'imagingStudies[' + ${iterStat.index} + '].modalityCode'"
                                        th:value="${imagingStudyItem.modalityCode}" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold" th:for="'sopCode-' + ${iterStat.index}">SOP Code:</label>
                                    <input type="text" 
                                        class="form-control"
                                        th:id="'sopCode-' + ${iterStat.index}"
                                        th:name="'imagingStudies[' + ${iterStat.index} + '].sopCode'"
                                        th:value="${imagingStudyItem.sopCode}" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold" th:for="'bodySiteCode-' + ${iterStat.index}">Body Site Code:</label>
                                    <input type="text" 
                                        class="form-control"
                                        th:id="'bodySiteCode-' + ${iterStat.index}"
                                        th:name="'imagingStudies[' + ${iterStat.index} + '].bodySiteCode'"
                                        th:value="${imagingStudyItem.bodySiteCode}" />
                                </div>
                                <div class="col-12 text-end">
                                    <button type="button" class="btn btn-danger btn-sm" 
                                            th:attr="onclick='remove(this)'">
                                        Remove
                                    </button>
                                </div>
                            </div>
                        </li>
                        <li th:if="${imagingStudy == null || imagingStudy.isEmpty()}" 
                            class="text-muted text-center p-3">
                            No imaging studies available
                        </li>
                    </ul>
                    <div class="text-center">
                        <button type="button" class="btn btn-primary" 
                                th:attr="onclick='addImagingStudy(\'imagingStudies-' + ${encounter.id} + '\')'">
                            Add Imaging Study
                        </button>
                    </div>
                </div>

                <!-- Immunizations Section -->
                <div class="accordion" th:attr="onclick='toggleAccordion(\'immunizations-' + ${encounter.id} + '\')'">
                    Immunizations
                </div>
                <div th:attr="id='immunizations-' + ${encounter.id}" class="panel" data-level="2">
                    <ul class="list-unstyled">
                        <li th:if="${immunization != null && !immunization.isEmpty()}" 
                            th:each="immunizationItem, iterStat : ${immunization}"
                            class="mb-3 p-3 border rounded bg-white shadow-sm">

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold" th:for="'description-' + ${iterStat.index}">Description:</label>
                                    <input type="text" 
                                        class="form-control"
                                        th:id="'description-' + ${iterStat.index}"
                                        th:name="'immunizations[' + ${iterStat.index} + '].description'"
                                        th:value="${immunizationItem.description}" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold" th:for="'code-' + ${iterStat.index}">Code:</label>
                                    <input type="text" 
                                        class="form-control"
                                        th:id="'code-' + ${iterStat.index}"
                                        th:name="'immunizations[' + ${iterStat.index} + '].code'"
                                        th:value="${immunizationItem.code}" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold" th:for="'date-' + ${iterStat.index}">Date:</label>
                                    <input type="text"
                                        class="form-control"
                                        th:id="'date-' + ${iterStat.index}"
                                        th:name="'immunizations[' + ${iterStat.index} + '].date'"
                                        th:value="${immunizationItem.date}" />
                                </div>
                                <div class="col-12 text-end">
                                    <button type="button" class="btn btn-danger btn-sm" 
                                            th:attr="onclick='remove(this)'">
                                        Remove
                                    </button>
                                </div>
                            </div>
                        </li>
                        <li th:if="${immunization == null || immunization.isEmpty()}" 
                            class="text-muted text-center p-3">
                            No immunizations available
                        </li>
                    </ul>
                    <div class="text-center">
                        <button type="button" class="btn btn-primary" 
                                th:attr="onclick='addImmunization(\'immunizations-' + ${encounter.id} + '\')'">
                            Add Immunization
                        </button>
                    </div>
                </div>

                <!-- Submit Button -->
                <form id="dataForm">
                    <input type="hidden" th:name="encounterId" th:value="${encounter.id}" />
                    <button type="submit" onclick="submitForm(event)" class="submit-btn">Submit</button>
                </form>
            </div>
        </li>
    </ul>
</body>

</html>